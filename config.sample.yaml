# AltMount Configuration Sample
# Copy this file to config.yaml and modify for your setup

# WebDAV server configuration
webdav:
  port: 8080
  user: 'usenet'
  password: 'usenet'
  host: '' # External host/IP for .strm generation (defaults to localhost if empty)

# REST API configuration
api:
  prefix: '/api' # API endpoint prefix
  key_override: '' # 33-char API key override (takes precedence over database key, leave empty to use database)

# Authentication configuration
auth:
  login_required: true # Require login to access WebDAV and API (default: true)

# Database configuration
database:
  path: '/config/altmount.db' # Database for processing workflows

# Metadata filesystem configuration
metadata:
  root_path: '/config/metadata' # Directory to store metadata files (required)
  delete_source_nzb_on_removal: false # Delete source NZB file when metadata is removed (default: false)

# Streaming and download configuration
streaming:
  max_download_workers: 15 # Number of download workers
  max_cache_size_mb: 32 # Maximum cache size in MB for ahead download chunks (default: 32MB)

# RClone configuration (optional)
rclone:
  # Base path for rclone configuration directory
  # The rclone config file will be stored at <path>/rclone/rclone.conf
  # If empty, defaults to the same directory as this config file
  path: '' # RClone base path (defaults to config directory)

  # Encryption settings (optional for WebDAV backends)
  password: '' # Encryption password (optional)
  salt: '' # Encryption salt (optional)

  # RC (Remote Control) server configuration
  rc_enabled:
    false # Enable RC server connection (for cache refresh and mount operations)
    # NOTE: RC will be automatically enabled when mount_enabled is set to true
  rc_url:
    '' # External RC server URL (optional, e.g., "http://localhost:5573")
    # If empty, will start internal RC server on rc_port
  rc_port: 5573 # Port for internal RC server (changed from 5572 to match production defaults)
  rc_user: 'admin' # RC authentication username
  rc_pass: 'admin' # RC authentication password
  rc_options: {} # Additional RC server options (for internal server only)
    # Examples:
    # rc-web-gui: 'true'
    # rc-web-gui-no-open-browser: 'true'

  # Mount configuration - production-optimized defaults
  mount_enabled: false # Enable RClone mount (automatically enables rc_enabled when true)
  vfs_name: 'altmount' # Name of the VFS mount (default: altmount)
  mount_options: {} # Custom mount options (override specific settings below)

  # Mount-specific settings - matching production command defaults
  allow_other: true # Allow other users to access the mount (--allow-other)
  allow_non_empty: true # Allow mounting over non-empty directories (--allow-non-empty)
  read_only: false # Mount as read-only (false = read-write)
  timeout: '10m' # I/O timeout for mount operations (--timeout=10m)
  syslog: true # Enable syslog output (--syslog)

  # System and filesystem options
  log_level: 'INFO' # Log level for rclone operations
  uid: 1000 # User ID for file ownership (use 0 for root)
  gid: 1000 # Group ID for file ownership (use 0 for root)
  umask: '002' # File creation mask (--umask=002, allows group write)
  buffer_size: '32M' # Buffer size for file operations (--buffer-size=32M)
  attr_timeout: '1s' # Attribute timeout for FUSE (1 second)
  transfers: 4 # Number of parallel transfers

  # VFS Cache Settings - production-optimized for performance and reliability
  cache_dir: '' # VFS cache directory (empty = defaults to <rclone_path>/cache, e.g., /config/cache)
  vfs_cache_mode: 'full' # VFS cache mode: off|minimal|writes|full (--vfs-cache-mode=full)
  vfs_cache_max_size: '50G' # Maximum cache size (--vfs-cache-max-size=50G)
  vfs_cache_max_age: '504h' # Maximum cache age (--vfs-cache-max-age=504h, 21 days)
  read_chunk_size: '32M' # VFS read chunk size (--vfs-read-chunk-size=32M)
  read_chunk_size_limit: '2G' # Read chunk size limit (--vfs-read-chunk-size-limit=2G)
  vfs_read_ahead: '128M' # VFS read-ahead size (--vfs-read-ahead=128M)
  dir_cache_time: '10m' # Directory cache time (--dir-cache-time=10m)

  # Additional VFS settings (advanced configuration)
  vfs_cache_min_free_space: '1G' # Minimum free space for VFS cache
  vfs_disk_space_total: '1G' # Total disk space for VFS operations
  vfs_read_chunk_streams: 4 # Number of read chunk streams

  # Advanced settings - performance optimization
  no_mod_time: false # Don't read/write modification time (false = preserve times)
  no_checksum: false # Don't verify checksums on upload (false = verify checksums)
  async_read: true # Enable async read operations (--async-read=true)
  vfs_fast_fingerprint: false # Use fast fingerprinting for VFS
  use_mmap: false # Use memory-mapped files for reading

# Import processing configuration
import:
  max_processor_workers: 2 # Number of NZB processor workers
  queue_processing_interval_seconds: 5 # Queue processing interval in seconds
  # Allowed file extensions for import (video formats)
  allowed_file_extensions:
    - '.mp4'
    - '.mkv'
    - '.avi'
    - '.mov'
    - '.wmv'
    - '.flv'
    - '.webm'
    - '.m4v'
    - '.mpg'
    - '.mpeg'
    - '.m2ts'
    - '.ts'
    - '.vob'
    - '.3gp'
    - '.3g2'
    - '.h264'
    - '.h265'
    - '.hevc'
    - '.ogv'
    - '.ogm'
    - '.strm'
    - '.iso'
    - '.img'
    - '.divx'
    - '.xvid'
    - '.rm'
    - '.rmvb'
    - '.asf'
    - '.asx'
    - '.wtv'
    - '.mk3d'
    - '.dvr-ms'
  max_import_connections: 5 # Number of concurrent NNTP connections for validation and archive processing
  import_cache_size_mb: 64 # Cache size in MB for archive analysis
  segment_sample_percentage: 1 # Percentage of segments to sample for validation (1-100)
  import_strategy: 'NONE' # Import strategy: NONE (direct import), SYMLINK (create symlinks), STRM (create .strm files)
  import_dir: '' # Import directory (required when import_strategy is SYMLINK or STRM, must be absolute path)
  skip_health_check: true # Bypass Usenet article validation during import (default: true)

# Health monitoring configuration
health:
  enabled: false # Enable health monitoring service (default: false)
  library_dir: '' # Library directory to monitor (required when health is enabled, must be absolute path)
  cleanup_orphaned_metadata: false # Clean up orphaned files, metadata, and empty directories (when false, no cleanup occurs; when true, deletes orphaned library files, metadata files, and removes empty directories from library, import, and metadata paths, default: false)
  check_interval_seconds: 5 # Health check interval in seconds (default: 5)
  max_connections_for_health_checks: 5 # Number of NNTP connections for health checks (default: 5)
  segment_sample_percentage: 5 # Percentage of segments to sample for health validation (1-100, default: 5)
  library_sync_interval_minutes: 360 # Library synchronization interval in minutes (default: 360 = 6 hours)
  library_sync_concurrency: 1 # Number of concurrent library sync operations (default: 1)
  resolve_repair_on_import: false # Automatically resolve pending repairs in the same directory when a new file is imported (default: false)

# WebDAV mount path configuration
mount_path: '' # WebDAV mount path, Example: '/mnt/altmount' or '/mnt/unionfs'. Must be an absolute path starting with /

# SABnzbd-compatible API configuration
sabnzbd:
  enabled: false # Enable SABnzbd-compatible API
  complete_dir: '/' # Base virtual directory (relative to mount point, defaults to root)
  categories: # Download categories
    - name: 'Default' # System default category (name cannot be changed)
      order: 0
      priority: 0
      dir: 'complete' # Default directory for uncategorized downloads
    - name: 'movies'
      order: 1
      priority: 0
      dir: 'movies'
    - name: 'tv'
      order: 2
      priority: 0
      dir: 'tv'
  # Fallback configuration for sending failed imports to external SABnzbd
  fallback_host: '' # External SABnzbd URL (e.g., "http://localhost:8080")
  fallback_api_key: '' # External SABnzbd API key

# Radarr/Sonarr arrs configuration
arrs:
  enabled: false # Enable arrs service
  max_workers: 5 # Number of concurrent workers (default: 5)
  radarr_instances: [] # Radarr instances (configured via UI)
  sonarr_instances: [] # Sonarr instances (configured via UI)
  # Queue Cleanup Configuration
  queue_cleanup_enabled: true # Enable automatic queue cleanup for failed imports (default: true)
  queue_cleanup_interval_seconds: 10 # Interval in seconds to check for failed imports (default: 10)
  cleanup_automatic_import_failure: false # Enable cleanup of "Automatic import is not possible" errors (default: false)
  queue_cleanup_allowlist: [] # List of additional error messages to treat as safe for cleanup
  # Example:
  # queue_cleanup_allowlist:
  #   - "Not a Custom Format upgrade"
  #   - "Ignored Message 2"
  # Example instance configuration (use the web UI instead):
  # radarr_instances:
  #   - name: "radarr-main"
  #     url: "http://localhost:7878"
  #     api_key: "your-radarr-api-key"
  #     enabled: true
  # sonarr_instances:
  #   - name: "sonarr-main"
  #     url: "http://localhost:8989"
  #     api_key: "your-sonarr-api-key"
  #     enabled: true

# Logging configuration with rotation support
log:
  file: '/config/altmount.log' # Log file path (empty = console only, defaults to same directory as config file)
  level: 'info' # Log level: debug, info, warn, error
  max_size: 100 # Maximum size in MB before rotation
  max_age: 30 # Maximum age in days to keep old files
  max_backups: 10 # Maximum number of old files to keep
  compress: true # Compress old log files

# Global log level (legacy - use log.level instead)
log_level: 'info'

# Profiler configuration
profiler_enabled: false # Enable performance profiling (default: false)

# NNTP Providers Configuration
# Configure multiple providers for redundancy and load balancing
providers:
  # Primary provider with SSL
  - id: 1 # Auto-generated hash ID based on host:port@username (leave empty for auto-generation)
    host: 'ssl-news.provider.com' # Replace with your provider's SSL hostname
    port: 563
    username: 'your_username' # Replace with your username
    password: 'your_password' # Replace with your password
    max_connections: 20
    tls: true
    insecure_tls: false
    enabled: true # Enable/disable this provider (default: true)
    is_backup_provider: false # Mark as backup provider (default: false)

  # Backup provider without SSL
  - id: 2 # Auto-generated hash ID (leave empty for auto-generation)
    host: 'news.provider.com' # Replace with your provider's standard hostname
    port: 119
    username: 'your_username' # Replace with your username
    password: 'your_password' # Replace with your password
    max_connections: 10
    tls: false
    insecure_tls: false
    enabled: true
    is_backup_provider: true # This is a backup provider


  # Secondary provider (optional)
  # - id: '' # Auto-generated
  #   host: "news.otherprovider.com"
  #   port: 563
  #   username: "other_username"
  #   password: "other_password"
  #   max_connections: 15
  #   tls: true
  #   insecure_tls: false
  #   enabled: true
  #   is_backup_provider: false
# Configuration Notes:
#
# 1. Authentication:
#    - Controls access to WebDAV and API endpoints
#    - Set login_required to false to allow anonymous access
#    - When enabled, uses WebDAV credentials for authentication
#
# 2. REST API:
#    - Provides HTTP endpoints for queue, health, and configuration management
#    - Available at http://server:port/api/ when enabled
#    - Authentication controlled by auth.login_required setting
#    - Supports JSON responses with pagination and filtering
#
# 3. Architecture:
#    - Uses filesystem-based metadata instead of main database
#    - Queue database still used for processing workflows and scraper data
#    - Better performance and scalability than database approach
#
# 4. NNTP Providers:
#    - At least one provider must be configured for download functionality
#    - Multiple providers provide redundancy and load balancing
#    - SSL/TLS is recommended when available (port 563)
#    - Standard unencrypted connections typically use port 119
#    - Provider IDs are auto-generated based on host:port@username
#    - Mark backup providers with is_backup_provider flag
#
# 5. Max Connections:
#    - Set based on your provider's limits
#    - More connections = faster downloads but higher resource usage
#    - Typical range: 10-50 connections per provider
#
# 6. Workers:
#    - Download workers: Number of concurrent download threads (streaming section)
#    - Import processor workers: Number of NZB processing threads
#    - Import connections: NNTP connections for validation and archive processing
#    - Health check connections: NNTP connections for file health validation
#    - ARRs max workers: Concurrent workers for ARR operations
#    - Adjust based on your system resources and provider limits
#
# 7. Streaming Configuration:
#    - Max Range Size: Maximum size for a single HTTP range request
#    - Streaming Chunk Size: Size of chunks when streaming files
#    - Max Download Workers: Number of concurrent download workers
#    - Max Cache Size: Cache size in MB for ahead download chunks
#
# 8. Import Configuration:
#    - Allowed file extensions: List of supported video file formats
#    - Import strategy: NONE (direct), SYMLINK (create symlinks), STRM (create .strm files)
#    - Import directory required when using SYMLINK or STRM strategy
#    - Segment sampling: Percentage of segments to validate for integrity
#
# 9. RClone Integration:
#    - Enable RClone mount for WebDAV filesystem mounting
#    - RC (Remote Control) server provides full control over mount operations
#    - Automatic health monitoring and recovery
#    - Optional encryption with password and salt
#    - Mount options allow customization (vfs-cache-mode, buffer-size, etc.)
#    - RC server runs on configurable port with authentication
#    - Legacy VFS configuration maintained for backward compatibility
#
# 10. Health Monitoring:
#     - Provides system health checks and monitoring
#     - Monitors database, metadata, providers, and VFS status
#     - Accessible via REST API endpoints
#     - Library directory required when health is enabled
#     - Cleanup orphaned metadata: Remove metadata for files no longer in library
#     - Library sync: Periodically synchronize library state
#     - Segment sampling: Percentage of segments to validate for health checks
#
# 11. SABnzbd Compatibility:
#     - Provides SABnzbd-compatible API endpoints
#     - Configure mount directory where WebDAV will be accessible
#     - Optional download categories for organization
#     - Enable for integration with existing download clients
#     - Fallback to external SABnzbd for failed imports
#
# 12. Mount Path:
#     - Global WebDAV mount path configuration
#     - Used by ARRs service to strip mount prefix from file paths
#     - Must be an absolute path when ARRs is enabled
#     - Example: '/mnt/altmount' or '/mnt/unionfs'
#
# 13. ARRs Service:
#     - Automatically index files from Radarr and Sonarr instances
#     - Configure multiple instances of each service type
#     - Customizable scrape intervals (default 24 hours)
#     - Manage instances through the web interface
#     - Indexes movie and TV episode file paths for fast searching
#     - Max workers controls concurrent ARR operations
#
# 14. Paths:
#     - Use absolute paths for production deployments
#     - Relative paths are relative to the working directory
#     - Ensure the application has read/write access to all paths
#     - Metadata directory will be created automatically
#
# 15. Logging Configuration:
#     - Log file defaults to same directory as config file (e.g., "altmount.log")
#     - Set 'file' to custom path for different location (e.g., "./logs/altmount.log")
#     - Leave 'file' empty to log to console only
#     - Log rotation prevents disk space issues in production
#     - Old files are automatically compressed when 'compress: true'
#     - Supports backward compatibility with top-level 'log_level'
#
# 16. Security:
#     - Store credentials securely
#     - Consider using environment variables for sensitive data
#     - Use strong passwords for WebDAV authentication
#     - API keys for Radarr/Sonarr should be kept secure
#     - Provider passwords are masked in API responses
#
# 17. Performance:
#     - Enable profiler_enabled for performance analysis and optimization
#     - Monitor resource usage and adjust worker counts accordingly
